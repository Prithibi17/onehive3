<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneHive | Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Outfit', sans-serif; background: #f4f7f6; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .box { background: white; padding: 40px; border-radius: 20px; width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { color: #082347; margin-bottom: 20px; }
        
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        
        button { width: 100%; padding: 12px; background: #082347; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.3s; }
        button:hover { background: #FF9900; }
        
        p { font-size: 14px; margin-top: 15px; color: #555; }
        a { color: #FF9900; text-decoration: none; font-weight: bold; }
        
        .forgot-link {
            display: block;
            text-align: right;
            margin-top: 5px;
            font-size: 13px;
            color: #082347;
            cursor: pointer;
        }
        .forgot-link:hover { color: #FF9900; text-decoration: underline; }
        
        /* BACK TO HOME LINK STYLE */
        .home-link { 
            display: inline-block; margin-top: 20px; 
            color: #777; font-size: 13px; text-decoration: none; 
            border: 1px solid #ddd; padding: 8px 15px; border-radius: 20px;
            transition: 0.3s;
        }
        .home-link:hover { background: #eee; color: #333; }
        
        /* Screen transitions */
        .screen { display: none; }
        .screen.active { display: block; }
        
        .back-link {
            display: inline-block;
            margin-top: 15px;
            color: #777;
            font-size: 13px;
            cursor: pointer;
        }
        .back-link:hover { color: #082347; }
    </style>
</head>
<body>
    <!-- SIMPLE NAVBAR -->
    <nav style="background: #082347; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <a href="index.html" style="display: flex; align-items: center; gap: 10px; text-decoration: none;">
            <img src="img.jpg" alt="Logo" style="height: 40px; width: 40px; object-fit: contain; background: white; border-radius: 50%; padding: 3px;">
            <span style="font-size: 24px; font-weight: 800; color: white;">One<span style="color: #FF8800;">Hive</span></span>
        </a>
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="index.html" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; font-size: 14px;">Home</a>
            <a href="register.html" style="background: #FF8800; color: white; text-decoration: none; padding: 8px 20px; border-radius: 20px; font-weight: 600; font-size: 14px;">Register</a>
        </div>
    </nav>
    
    <div class="box">
        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <h2>Welcome Back</h2>
            <input type="email" id="loginEmail" placeholder="Email Address">
            <input type="password" id="loginPass" placeholder="Password">
            <a class="forgot-link" onclick="showForgotPassword()">Forgot Password?</a>
            
            <button onclick="loginUser()">Login</button>
            
            <p>New here? <a href="register.html">Create Account</a></p>
            
            <a href="index.html" class="home-link"><i class="fas fa-arrow-left"></i> Back to Home</a>
            <br><br>
            <a href="admin.html" style="color: #777; font-size: 12px; text-decoration: none; border-bottom: 1px dashed #999;">Admin Login</a>
        </div>
        
        <!-- Forgot Password Screen -->
        <div id="forgotScreen" class="screen">
            <h2>Reset Password</h2>
            <p style="font-size: 13px;">Enter your registered email to receive OTP</p>
            <input type="email" id="forgotEmail" placeholder="Email Address">
            
            <button onclick="sendOTP()">Send OTP</button>
            
            <span class="back-link" onclick="showLogin()"><i class="fas fa-arrow-left"></i> Back to Login</span>
        </div>
        
        <!-- OTP Verification Screen -->
        <div id="otpScreen" class="screen">
            <h2>Verify OTP</h2>
            <p style="font-size: 13px;">Enter the OTP sent to your email</p>
            <input type="text" id="otpInput" placeholder="Enter OTP" maxlength="6" style="letter-spacing: 5px; text-align: center; font-size: 18px;">
            
            <button onclick="verifyOTP()">Verify OTP</button>
            
            <p style="font-size: 12px;">Didn't receive? <a href="#" onclick="sendOTP()">Resend OTP</a></p>
            
            <span class="back-link" onclick="showForgotPassword()"><i class="fas fa-arrow-left"></i> Back</span>
        </div>
        
        <!-- New Password Screen -->
        <div id="newPasswordScreen" class="screen">
            <h2>New Password</h2>
            <p style="font-size: 13px;">Enter your new password</p>
            <input type="password" id="newPass" placeholder="New Password" maxlength="10">
            <input type="password" id="confirmPass" placeholder="Confirm Password" maxlength="10">
            
            <button onclick="resetPassword()">Reset Password</button>
            
            <span class="back-link" onclick="showOTP()"><i class="fas fa-arrow-left"></i> Back</span>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:3000/api';
        let resetEmail = '';
        
        // Check if already logged in
        if (localStorage.getItem('token')) {
            window.location.href = 'index.html';
        }

        // Screen navigation
        function showLogin() {
            document.getElementById('loginScreen').classList.add('active');
            document.getElementById('forgotScreen').classList.remove('active');
            document.getElementById('otpScreen').classList.remove('active');
            document.getElementById('newPasswordScreen').classList.remove('active');
        }
        
        function showForgotPassword() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('forgotScreen').classList.add('active');
            document.getElementById('otpScreen').classList.remove('active');
            document.getElementById('newPasswordScreen').classList.remove('active');
        }
        
        function showOTP() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('forgotScreen').classList.remove('active');
            document.getElementById('otpScreen').classList.add('active');
            document.getElementById('newPasswordScreen').classList.remove('active');
        }
        
        function showNewPassword() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('forgotScreen').classList.remove('active');
            document.getElementById('otpScreen').classList.remove('active');
            document.getElementById('newPasswordScreen').classList.add('active');
        }

        function loginUser() {
            let email = document.getElementById('loginEmail').value.trim().toLowerCase();
            let password = document.getElementById('loginPass').value.trim();

            if(!email || !password) { 
                alert("Please fill all fields."); 
                return; 
            }

            // Call API
            fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Save to localStorage
                    localStorage.setItem('token', data.data.token);
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userName', data.data.user.name);
                    localStorage.setItem('currentUserEmail', data.data.user.email);
                    localStorage.setItem('userRole', data.data.user.role);
                    localStorage.setItem('userId', data.data.user.id);
                    
                    alert("✅ Login Successful! Welcome " + data.data.user.name);
                    window.location.href = "index.html";
                } else {
                    alert("❌ " + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("❌ Login failed. Please try again.");
            });
        }
        
        function sendOTP() {
            let email = document.getElementById('forgotEmail').value.trim().toLowerCase();
            
            if(!email) {
                alert("Please enter your email address.");
                return;
            }
            
            fetch(`${API_URL}/auth/send-otp`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    resetEmail = email;
                    alert("✅ OTP sent to your email!");
                    showOTP();
                } else {
                    alert("❌ " + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert("❌ Failed to send OTP. Please try again.");
            });
        }
        
        function verifyOTP() {
            let otp = document.getElementById('otpInput').value.trim();
            
            if(!otp) {
                alert("Please enter the OTP.");
                return;
            }
            
            fetch(`${API_URL}/auth/verify-otp`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: resetEmail, otp })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    alert("✅ OTP Verified!");
                    showNewPassword();
                } else {
                    alert("❌ " + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert("❌ Verification failed. Please try again.");
            });
        }
        
        function resetPassword() {
            let newPass = document.getElementById('newPass').value;
            let confirmPass = document.getElementById('confirmPass').value;
            
            if(!newPass || !confirmPass) {
                alert("Please enter both passwords.");
                return;
            }
            
            if(newPass !== confirmPass) {
                alert("❌ Passwords do not match!");
                return;
            }
            
            // Password strength check (same as register)
            const strongPasswordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{1,10}$/;
            if(!strongPasswordRegex.test(newPass)) {
                alert("❌ Weak Password! Use uppercase, lowercase, number, and special character.");
                return;
            }
            
            fetch(`${API_URL}/auth/reset-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: resetEmail, newPassword: newPass })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    alert("✅ Password reset successful! Please login with your new password.");
                    showLogin();
                    document.getElementById('loginEmail').value = resetEmail;
                    document.getElementById('loginPass').value = '';
                } else {
                    alert("❌ " + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert("❌ Password reset failed. Please try again.");
            });
        }
        
        // Handle Enter key
        document.getElementById('loginPass').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') loginUser();
        });
        
        document.getElementById('otpInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') verifyOTP();
        });
    </script>
</body>
</html>